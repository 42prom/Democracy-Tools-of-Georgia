# DTG Backend Environment Variables
# Copy to .env and update values for your environment

# =============================================================================
# Server Configuration
# =============================================================================
PORT=3000
NODE_ENV=development

# =============================================================================
# Database Configuration
# =============================================================================
# For Docker: use service names (postgres, redis)
# For local dev: use localhost
DATABASE_URL=postgresql://dtg_user:dtg_dev_password@localhost:5432/dtg
REDIS_URL=redis://localhost:6379

# =============================================================================
# Security - MUST CHANGE IN PRODUCTION
# =============================================================================
# JWT secret for token signing (min 32 chars, use random string)
# Generate with: openssl rand -base64 48
JWT_SECRET=CHANGE_ME_IN_PRODUCTION_USE_RANDOM_64_CHAR_STRING

# CORS origin for admin panel (production: your actual domain)
CORS_ORIGIN=http://localhost:5173

# =============================================================================
# Biometric Microservice
# =============================================================================
# For Docker: http://biometric-service:8000
# For local dev: http://localhost:8000
BIOMETRIC_SERVICE_URL=http://localhost:8000
BIOMETRIC_TIMEOUT_MS=15000
BIOMETRIC_MAX_RETRIES=2

# =============================================================================
# Rate Limiting
# =============================================================================
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# =============================================================================
# Privacy Settings
# =============================================================================
# Minimum votes before results shown (k-anonymity threshold)
# Production: 30 minimum (enforced at startup)
# Development: can be lower for testing
MIN_K_ANONYMITY=30

# =============================================================================
# Blockchain (MVP Placeholder)
# =============================================================================
BLOCKCHAIN_PROVIDER=http://localhost:8545
CONTRACT_ADDRESS=0x0000000000000000000000000000000000000000

# =============================================================================
# Logging
# =============================================================================
LOG_LEVEL=info

# =============================================================================
# User Privacy & Hashing - CRITICAL: Generate unique secrets for production
# =============================================================================
# Each secret should be unique and generated securely:
#   openssl rand -base64 32
# These secrets are used for irreversible hashing - losing them means data loss
PN_HASH_SECRET=dev_pn_hash_secret_change_me
API_KEY_ENCRYPTION_SECRET=dev_api_key_enc_secret_change_me_32+chars
DEVICE_HASH_SECRET=dev_device_secret_change_me
VOTER_HASH_SECRET=dev_voter_secret_change_me

# =============================================================================
# Flags & Limits
# =============================================================================
ALLOW_MOCK_LOGIN=false
BYPASS_ADMIN_AUTH=false
ENABLE_DEBUG_LOGGING=false
ENABLE_PRIVACY_NOISE=true
BODY_LIMIT=10mb

# =============================================================================
# Firebase (Push Notifications)
# =============================================================================
FIREBASE_DISABLED=false
FIREBASE_SERVICE_ACCOUNT_JSON=
FIREBASE_SERVICE_ACCOUNT_PATH=

# =============================================================================
# VPN / Proxy Detection (Optional)
# =============================================================================
IPQUALITYSCORE_API_KEY=
IPHUB_API_KEY=
PROXYCHECK_API_KEY=

# =============================================================================
# Blockchain
# =============================================================================
BLOCKCHAIN_PRIVATE_KEY=0x0000000000000000000000000000000000000000000000000000000000000000

# =============================================================================
# Election-Grade Cryptography — MUST SET IN PRODUCTION
# =============================================================================
# Server-side nullifier secret (HMAC-SHA256 key binding voter+poll to nullifier).
# CRITICAL: Loss or rotation causes all existing nullifiers to be re-generated,
#           potentially allowing a voter who already voted to vote again if the DB
#           nullifier table is cleared. Never rotate without also clearing nullifiers.
# Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
NULLIFIER_SECRET=dev_nullifier_secret_change_me_in_production

# Ed25519 keypair for signing cryptographic vote receipts.
# Generate with:
#   node -e "
#     const {generateKeyPairSync}=require('crypto');
#     const {privateKey,publicKey}=generateKeyPairSync('ed25519',{
#       privateKeyEncoding:{type:'pkcs8',format:'pem'},
#       publicKeyEncoding:{type:'spki',format:'pem'}
#     });
#     console.log('PRIVATE:\n'+privateKey);
#     console.log('PUBLIC:\n'+publicKey);
#   "
# Store the private key inline (replace newlines with \n) or use a secrets manager.
RECEIPT_PRIVATE_KEY_PEM=
RECEIPT_PUBLIC_KEY_PEM=

# =============================================================================
# Phase 2 — Pluggable Crypto & ZK Configuration
# =============================================================================
# Hash algorithm for nullifiers:
#   hmac     → HMAC-SHA256 (default, no extra deps, production safe)
#   poseidon → Poseidon BN254 (ZK-SNARK compatible; requires: npm install circomlibjs snarkjs)
CRYPTO_HASHER=hmac

# =============================================================================
# Phase 2 — Secrets Management (HashiCorp Vault)
# =============================================================================
# Leave blank to use .env values (development / Docker).
# Set both to enable Vault in production:
#   docker run --cap-add=IPC_LOCK -e VAULT_DEV_ROOT_TOKEN_ID=dtg-dev-token -p 8200:8200 vault
#   vault kv put secret/dtg NULLIFIER_SECRET="..." JWT_SECRET="..." RECEIPT_PRIVATE_KEY_PEM="..."
VAULT_ADDR=
VAULT_TOKEN=
VAULT_SECRET_PATH=secret/data/dtg

# =============================================================================
# Production Checklist (remove this section when deploying)
# =============================================================================
# [ ] All *_SECRET variables regenerated with `openssl rand -base64 48`
# [ ] NULLIFIER_SECRET set and stored securely (never rotate without reading docs)
# [ ] RECEIPT_PRIVATE_KEY_PEM / RECEIPT_PUBLIC_KEY_PEM generated and stored in vault
# [ ] CRYPTO_HASHER=hmac in production (poseidon requires ZK setup steps)
# [ ] VAULT_ADDR + VAULT_TOKEN configured for production secrets
# [ ] NODE_ENV=production
# [ ] CORS_ORIGIN set to actual admin domain
# [ ] MIN_K_ANONYMITY >= 30
# [ ] Database credentials rotated from defaults
# [ ] SSL/TLS configured at load balancer
# [ ] Run: npx ts-node src/scripts/verify_vote_integrity.ts after each deployment
